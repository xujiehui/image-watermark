<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾ç‰‡æ°´å°æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 30px;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2em;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .section-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #495057;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #495057;
      font-weight: 500;
    }

    input[type="file"],
    input[type="text"],
    input[type="number"],
    input[type="color"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }

    input[type="file"] {
      padding: 8px;
    }

    input[type="checkbox"] {
      width: auto;
      margin-right: 5px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .preview-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }

    .preview-box {
      text-align: center;
    }

    .preview-box h3 {
      margin-bottom: 15px;
      color: #495057;
    }

    .preview-image {
      max-width: 100%;
      max-height: 400px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .watermark-type {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .watermark-type label {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background: white;
      border: 2px solid #ced4da;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .watermark-type input[type="radio"] {
      margin-right: 8px;
    }

    .watermark-type input[type="radio"]:checked + span {
      color: #667eea;
      font-weight: bold;
    }

    .watermark-type label:has(input:checked) {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .watermark-config {
      display: none;
    }

    .watermark-config.active {
      display: block;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #667eea;
    }

    .loading.active {
      display: block;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 4px;
      margin-top: 10px;
      display: none;
    }

    .error.active {
      display: block;
    }

    @media (max-width: 768px) {
      .preview-section {
        grid-template-columns: 1fr;
      }

      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ–¼ï¸ å›¾ç‰‡æ°´å°æµ‹è¯•å·¥å…·</h1>

    <!-- æºå›¾ç‰‡ä¸Šä¼  -->
    <div class="section">
      <div class="section-title">1. é€‰æ‹©æºå›¾ç‰‡</div>
      <div class="form-group">
        <label for="sourceImage">ä¸Šä¼ å›¾ç‰‡</label>
        <input type="file" id="sourceImage" accept="image/*">
      </div>
      <div id="sourcePreview" style="margin-top: 15px;"></div>
    </div>

    <!-- æ°´å°é…ç½® -->
    <div class="section">
      <div class="section-title">2. é…ç½®æ°´å°</div>
      
      <div class="watermark-type">
        <label>
          <input type="radio" name="watermarkType" value="text" checked>
          <span>æ–‡å­—æ°´å°</span>
        </label>
        <label>
          <input type="radio" name="watermarkType" value="image">
          <span>å›¾ç‰‡æ°´å°</span>
        </label>
      </div>

      <!-- æ–‡å­—æ°´å°é…ç½® -->
      <div id="textWatermarkConfig" class="watermark-config active">
        <div class="form-group">
          <label for="watermarkText">æ°´å°æ–‡å­—</label>
          <input type="text" id="watermarkText" value="æµ‹è¯•æ°´å°" placeholder="è¾“å…¥æ°´å°æ–‡å­—">
        </div>
        <div class="row">
          <div class="form-group">
            <label for="fontSize">å­—ä½“å¤§å°</label>
            <input type="number" id="fontSize" value="24" min="10" max="100">
          </div>
          <div class="form-group">
            <label for="fontColor">å­—ä½“é¢œè‰²</label>
            <input type="color" id="fontColor" value="#ffffff">
          </div>
        </div>
        <div class="row">
          <div class="form-group">
            <label for="fontFamily">å­—ä½“å®¶æ—</label>
            <select id="fontFamily">
              <option value="Arial">Arial</option>
              <option value="Microsoft YaHei">Microsoft YaHei</option>
              <option value="SimSun">SimSun</option>
              <option value="SimHei">SimHei</option>
              <option value="KaiTi">KaiTi</option>
            </select>
          </div>
          <div class="form-group">
            <label for="fontWeight">å­—ä½“ç²—ç»†</label>
            <select id="fontWeight">
              <option value="normal">normal</option>
              <option value="bold">bold</option>
              <option value="300">300</option>
              <option value="400">400</option>
              <option value="500">500</option>
              <option value="600">600</option>
              <option value="700">700</option>
            </select>
          </div>
        </div>
      </div>

      <!-- å›¾ç‰‡æ°´å°é…ç½® -->
      <div id="imageWatermarkConfig" class="watermark-config">
        <div class="form-group">
          <label for="watermarkImage">æ°´å°å›¾ç‰‡</label>
          <input type="file" id="watermarkImage" accept="image/*">
        </div>
        <div class="row">
          <div class="form-group">
            <label for="watermarkWidth">æ°´å°å®½åº¦</label>
            <input type="number" id="watermarkWidth" value="100" min="10" max="500" placeholder="ç•™ç©ºä½¿ç”¨åŸå›¾å®½åº¦">
          </div>
          <div class="form-group">
            <label for="watermarkHeight">æ°´å°é«˜åº¦</label>
            <input type="number" id="watermarkHeight" value="100" min="10" max="500" placeholder="ç•™ç©ºä½¿ç”¨åŸå›¾é«˜åº¦">
          </div>
        </div>
      </div>

      <!-- é€šç”¨é…ç½® -->
      <div class="section-title" style="margin-top: 20px;">é€šç”¨é…ç½®</div>
      <div class="row">
        <div class="form-group">
          <label for="position">æ°´å°ä½ç½®</label>
          <select id="position">
            <option value="top-left">å·¦ä¸Šè§’</option>
            <option value="top-center">é¡¶éƒ¨å±…ä¸­</option>
            <option value="top-right">å³ä¸Šè§’</option>
            <option value="left-center">å·¦ä¾§å±…ä¸­</option>
            <option value="center">å±…ä¸­</option>
            <option value="right-center">å³ä¾§å±…ä¸­</option>
            <option value="bottom-left">å·¦ä¸‹è§’</option>
            <option value="bottom-center">åº•éƒ¨å±…ä¸­</option>
            <option value="bottom-right" selected>å³ä¸‹è§’</option>
          </select>
        </div>
        <div class="form-group">
          <label for="opacity">é€æ˜åº¦ (0-1)</label>
          <input type="number" id="opacity" value="0.7" min="0" max="1" step="0.1">
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="rotate">æ—‹è½¬è§’åº¦ (åº¦)</label>
          <input type="number" id="rotate" value="0" min="-180" max="180">
        </div>
        <div class="form-group">
          <label for="offsetX">X åç§» (åƒç´ )</label>
          <input type="number" id="offsetX" value="10" min="0">
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="offsetY">Y åç§» (åƒç´ )</label>
          <input type="number" id="offsetY" value="10" min="0">
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="repeat">
            <span>é‡å¤é“ºæ»¡æ•´ä¸ªå›¾ç‰‡</span>
          </label>
        </div>
      </div>
      <div class="form-group" id="repeatSpacingGroup">
        <label for="repeatSpacing">é‡å¤é—´è· (åƒç´ )</label>
        <input type="number" id="repeatSpacing" value="50" min="10" max="200">
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="button-group">
      <button class="btn-primary" id="addWatermarkBtn">æ·»åŠ æ°´å°</button>
      <button class="btn-secondary" id="resetBtn">é‡ç½®</button>
      <button class="btn-success" id="downloadBtn" style="display: none;">ä¸‹è½½å›¾ç‰‡</button>
    </div>

    <div class="loading" id="loading">å¤„ç†ä¸­...</div>
    <div class="error" id="error"></div>

    <!-- é¢„è§ˆåŒºåŸŸ -->
    <div class="preview-section" id="previewSection" style="display: none;">
      <div class="preview-box">
        <h3>åŸå›¾</h3>
        <img id="originalPreview" class="preview-image" alt="åŸå›¾">
      </div>
      <div class="preview-box">
        <h3>å¸¦æ°´å°å›¾ç‰‡</h3>
        <img id="watermarkedPreview" class="preview-image" alt="å¸¦æ°´å°å›¾ç‰‡">
      </div>
    </div>
  </div>

  <script type="module">
    import { addWatermarkToImage } from './dist/index.esm.js';

    // DOM å…ƒç´ 
    const sourceImageInput = document.getElementById('sourceImage');
    const watermarkTypeRadios = document.querySelectorAll('input[name="watermarkType"]');
    const textWatermarkConfig = document.getElementById('textWatermarkConfig');
    const imageWatermarkConfig = document.getElementById('imageWatermarkConfig');
    const addWatermarkBtn = document.getElementById('addWatermarkBtn');
    const resetBtn = document.getElementById('resetBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const previewSection = document.getElementById('previewSection');
    const originalPreview = document.getElementById('originalPreview');
    const watermarkedPreview = document.getElementById('watermarkedPreview');
    const repeatCheckbox = document.getElementById('repeat');
    const repeatSpacingGroup = document.getElementById('repeatSpacingGroup');

    let currentResult = null;
    let sourceFile = null;

    // åˆ‡æ¢æ°´å°ç±»å‹
    watermarkTypeRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (e.target.value === 'text') {
          textWatermarkConfig.classList.add('active');
          imageWatermarkConfig.classList.remove('active');
        } else {
          textWatermarkConfig.classList.remove('active');
          imageWatermarkConfig.classList.add('active');
        }
      });
    });

    // é‡å¤æ¨¡å¼åˆ‡æ¢
    repeatCheckbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        repeatSpacingGroup.style.display = 'block';
      } else {
        repeatSpacingGroup.style.display = 'none';
      }
    });

    // æºå›¾ç‰‡é¢„è§ˆ
    sourceImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        sourceFile = file;
        const url = URL.createObjectURL(file);
        originalPreview.src = url;
        previewSection.style.display = 'grid';
        downloadBtn.style.display = 'none';
        currentResult = null;
      }
    });

    // æ·»åŠ æ°´å°
    addWatermarkBtn.addEventListener('click', async () => {
      if (!sourceFile) {
        showError('è¯·å…ˆé€‰æ‹©æºå›¾ç‰‡');
        return;
      }

      const watermarkType = document.querySelector('input[name="watermarkType"]:checked').value;
      
      loading.classList.add('active');
      error.classList.remove('active');
      addWatermarkBtn.disabled = true;

      try {
        let watermarks;

        if (watermarkType === 'text') {
          const watermarkText = document.getElementById('watermarkText').value;
          if (!watermarkText.trim()) {
            throw new Error('è¯·è¾“å…¥æ°´å°æ–‡å­—');
          }

          watermarks = {
            text: watermarkText,
            fontSize: parseInt(document.getElementById('fontSize').value),
            color: document.getElementById('fontColor').value,
            fontFamily: document.getElementById('fontFamily').value,
            fontWeight: document.getElementById('fontWeight').value,
            opacity: parseFloat(document.getElementById('opacity').value),
            rotate: parseInt(document.getElementById('rotate').value),
            position: document.getElementById('position').value,
            offset: {
              x: parseInt(document.getElementById('offsetX').value),
              y: parseInt(document.getElementById('offsetY').value),
            },
            repeat: repeatCheckbox.checked,
            repeatSpacing: parseInt(document.getElementById('repeatSpacing').value),
          };
        } else {
          const watermarkImageInput = document.getElementById('watermarkImage');
          const watermarkImageFile = watermarkImageInput.files[0];
          if (!watermarkImageFile) {
            throw new Error('è¯·é€‰æ‹©æ°´å°å›¾ç‰‡');
          }

          watermarks = {
            image: watermarkImageFile,
            width: document.getElementById('watermarkWidth').value 
              ? parseInt(document.getElementById('watermarkWidth').value) 
              : undefined,
            height: document.getElementById('watermarkHeight').value 
              ? parseInt(document.getElementById('watermarkHeight').value) 
              : undefined,
            opacity: parseFloat(document.getElementById('opacity').value),
            rotate: parseInt(document.getElementById('rotate').value),
            position: document.getElementById('position').value,
            offset: {
              x: parseInt(document.getElementById('offsetX').value),
              y: parseInt(document.getElementById('offsetY').value),
            },
            repeat: repeatCheckbox.checked,
            repeatSpacing: parseInt(document.getElementById('repeatSpacing').value),
          };
        }

        const result = await addWatermarkToImage({
          source: sourceFile,
          watermarks,
          outputFormat: 'image/png',
          quality: 0.92,
        });

        currentResult = result;
        watermarkedPreview.src = result.url;
        downloadBtn.style.display = 'inline-block';
      } catch (err) {
        showError(err.message || 'æ·»åŠ æ°´å°å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
        console.error('Error:', err);
      } finally {
        loading.classList.remove('active');
        addWatermarkBtn.disabled = false;
      }
    });

    // ä¸‹è½½å›¾ç‰‡
    downloadBtn.addEventListener('click', () => {
      if (!currentResult) return;

      const a = document.createElement('a');
      a.href = currentResult.url;
      a.download = `watermarked-${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // é‡ç½®
    resetBtn.addEventListener('click', () => {
      sourceImageInput.value = '';
      document.getElementById('watermarkImage').value = '';
      sourceFile = null;
      currentResult = null;
      previewSection.style.display = 'none';
      downloadBtn.style.display = 'none';
      originalPreview.src = '';
      watermarkedPreview.src = '';
      error.classList.remove('active');
    });

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      error.textContent = message;
      error.classList.add('active');
    }
  </script>
</body>
</html>

